#!/bin/sh

set -e

if [ -n "$CI_CONTEXT_LIST" ]; then
  if [ "$CI_CONTEXT" = "*" ] || [ -z "$CI_CONTEXT" ]; then
    CI_CONTEXT=$CI_CONTEXT_LIST
  fi
fi

jobs="[]"

runJob() {
  job="{}"
  job=$(echo $job | jq -rc --arg a "$JOB_ID" '.id = $a')
  job=$(echo $job | jq -rc --arg a "$CI_CONTEXT" '.context = $a')
  CI_ACTION=$(echo $CI_ACTION | sed 's/\.//g') # dot dot attack protection
  if ! [ -f /opt/jobs/${CI_ACTION}/create.sh ]; then
    job=$(echo $job | jq -rc --arg a "unkown action: ${CI_ACTION}" '.message = $a')
    job=$(echo $job | jq -rc --arg a "error" '.status = $a')
    jobs=$(echo $jobs | jq -r ". |= .+ [$job]")
    return 1
  fi
  if result=$(/opt/jobs/${CI_ACTION}/create.sh 2>&1); then
    job=$(echo $job | jq -rc --arg a "$result" '.message = $a')
    job=$(echo $job | jq -rc --arg a "success" '.status = $a')
    jobs=$(echo $jobs | jq -r ". |= .+ [$job]")
  else
    job=$(echo $job | jq -rc --arg a "$result" '.message = $a')
    job=$(echo $job | jq -rc --arg a "error" '.status = $a')
    jobs=$(echo $jobs | jq -r ". |= .+ [$job]")
    return 1
  fi
}

if [ -n "$CI_CONTEXT" ]; then
  CI_CONTEXT_LIST=$CI_CONTEXT
  for context in $(echo $CI_CONTEXT_LIST | sed "s/,/ /g"); do
    export CI_CONTEXT=$context
    runJob
  done
else
  runJob
fi

echo '{"jobs":[]}' | jq -rc ".jobs = $jobs"
